<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fichas Cadastradas</title>
    <link rel="stylesheet" href="../../css/fichareac.css" />
    <link rel="icon" href="assets/favicon.ico" type="image/x-icon" />
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
  </head>

  <body>
    <header><h1>Fichas Cadastradas</h1></header>

    <main>
      <div class="fichas-section">
        <div class="fichas-header">
          <!-- Botão de ordenação removido -->
        </div>

        <div style="margin: 1rem 0;">
          <input type="month" id="filtroMes" />
          <button onclick="filtrarPorMes()">Filtrar por mês</button>
          <button onclick="gerarPDF()">Gerar PDF</button>
        </div>

        <input
          type="text"
          id="buscaInput"
          placeholder="Buscar ficha..."
          onkeyup="filtrarTabela()"
          style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem;"
        />

        <div id="fichasContainer">
          <table id="fichasTabela" border="1" style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr>
                <th>Data</th>
                <th>Localidade</th>
                <th>Ação</th>
                <th>Responsável</th>
                <th>Observação</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </main>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyCnPcxbJaG3kwBjU7QRmTwOYM6amuAjx1o",
        authDomain: "teste-eff5e.firebaseapp.com",
        projectId: "teste-eff5e",
        storageBucket: "teste-eff5e.firebasestorage.app",
        messagingSenderId: "272404465161",
        appId: "1:272404465161:web:260b0242408081a17c9ad8"
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      let fichasCache = [];

      function formatarDataBR(dataISO) {
        if (!dataISO) return '';
        const [ano, mes, dia] = dataISO.split("-");
        return `${dia}/${mes}/${ano.slice(2)}`;
      }

      async function carregarFichas() {
        try {
          const snapshot = await db.collection('fichas').get();
          fichasCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          exibirFichas(fichasCache);
        } catch (error) {
          console.error('Erro ao carregar fichas:', error);
        }
      }

      function exibirFichas(fichas) {
        const tbody = document.querySelector('#fichasTabela tbody');
        tbody.innerHTML = '';
        fichas.forEach(ficha => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${formatarDataBR(ficha.data)}</td>
            <td>${ficha.localidade}</td>
            <td>${ficha.acao}</td>
            <td>${(ficha.responsavel || []).join(', ')}</td>
            <td>${ficha.observacao || '-'}</td>
            <td><button onclick="excluirFicha('${ficha.id}')">Excluir</button></td>
          `;
          tbody.appendChild(tr);
        });
      }

      async function excluirFicha(id) {
        if (!confirm('Confirma exclusão desta ficha?')) return;
        try {
          await db.collection('fichas').doc(id).delete();
          fichasCache = fichasCache.filter(f => f.id !== id);
          exibirFichas(fichasCache);
        } catch (error) {
          console.error('Erro ao excluir ficha:', error);
        }
      }

      function filtrarTabela() {
        const filtro = document.getElementById('buscaInput').value.toLowerCase();
        document.querySelectorAll('#fichasTabela tbody tr').forEach(row => {
          row.style.display = row.textContent.toLowerCase().includes(filtro) ? '' : 'none';
        });
      }

      function filtrarPorMes() {
        const valorMes = document.getElementById('filtroMes').value;
        if (!valorMes) return exibirFichas(fichasCache);

        const [ano, mes] = valorMes.split('-');
        const filtradas = fichasCache.filter(f => {
          const [fAno, fMes] = (f.data || '').split('-');
          return fAno === ano && fMes === mes;
        });

        exibirFichas(filtradas);
      }

      function gerarPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.text('Relatório de Ações', 14, 15);
        doc.autoTable({
          startY: 20,
          head: [['Data', 'Localidade', 'Ação', 'Responsável', 'Observação']],
          body: Array.from(document.querySelectorAll('#fichasTabela tbody tr')).map(tr =>
            Array.from(tr.querySelectorAll('td')).slice(0, 5).map(td => td.innerText)
          ),
          styles: { fontSize: 9 },
        });

        doc.save('relatorio_acoes.pdf');
      }

      carregarFichas();
    </script>
  </body>
</html>