<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ação Executada</title>
    <link rel="stylesheet" href="../../css/acaoreac.css" />
    <link rel="icon" href="assets/favicon.ico" type="image/x-icon" />
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  </head>
  <body>
    <header><h1>Ação Executada</h1></header>

    <main>
      <div class="form-section">
        <div class="form-grid">
          <input type="date" id="data" placeholder="Selecione a data" />
          <input type="text" id="localidade" placeholder="Localidade" />
          <select id="acaoSelect" onchange="verificarAcao()" required>
            <option value="" disabled selected>Ação Realizada</option>
            <option>Lavagem de rua</option>
            <option>Abastecimento de água</option>
            <option>Desobstrução de bueiros</option>
            <option>Vistoria em áreas de risco</option>
            <option>Levantamento de ocorrência</option>
            <option>Combate a incêndio</option>
            <option>Construção de pontes</option>
            <option>Desobstrução do rio</option>
            <option>Auxílio a secretarias</option>
            <option value="outros">Outros</option>
          </select>
          <input type="text" id="acaoPersonalizada" placeholder="Digite a ação" style="display: none;" />
          <select id="responsavel" multiple size="8">
            <option disabled hidden>Selecione os responsáveis...</option>
            <option>Anderson</option>
            <option>Bruno</option>
            <option>Josue</option>
            <option>Sadrack</option>
            <option>Nafitalison</option>
            <option>Elison</option>
            <option>Herik</option>
            <option>Silvano</option>
          </select>
          <input type="text" id="observacao" placeholder="Observação (opcional)" />
        </div>

        <div class="button-row">
          <button class="btn-salvar" onclick="adicionarFicha()">Salvar</button>
          <button class="btn-fichas" onclick="window.location.href='fichareac.html'">Registros</button>
        </div>
      </div>
    </main>

    <script>
      // Configuração do Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyCnPcxbJaG3kwBjU7QRmTwOYM6amuAjx1o",
        authDomain: "teste-eff5e.firebaseapp.com",
        projectId: "teste-eff5e",
        storageBucket: "teste-eff5e.appspot.com",
        messagingSenderId: "272404465161",
        appId: "1:272404465161:web:260b0242408081a17c9ad8"
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // Exibir campo de ação personalizada se "Outros" for selecionado
      function verificarAcao() {
        const select = document.getElementById('acaoSelect');
        const input = document.getElementById('acaoPersonalizada');
        input.style.display = select.value === 'outros' ? 'block' : 'none';
      }

      // Função para adicionar ficha no Firestore
      async function adicionarFicha() {
        const data = document.getElementById('data').value;
        const localidade = document.getElementById('localidade').value.trim();
        const acaoSelect = document.getElementById('acaoSelect').value;
        const acaoPersonalizada = document.getElementById('acaoPersonalizada').value.trim();
        const responsaveis = Array.from(document.getElementById('responsavel').selectedOptions).map(opt => opt.value);
        const observacao = document.getElementById('observacao').value.trim();
        const acao = acaoSelect === 'outros' ? acaoPersonalizada : acaoSelect;

        if (!data || !localidade || !acao || responsaveis.length === 0) {
          alert('Preencha todos os campos obrigatórios!');
          return;
        }

        try {
          await db.collection('fichas').add({
            data,
            localidade,
            acao,
            responsavel: responsaveis,
            observacao,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          });

          alert('Ficha salva com sucesso!');

          // Limpar formulário
          document.getElementById('data').value = '';
          document.getElementById('localidade').value = '';
          document.getElementById('acaoSelect').value = '';
          document.getElementById('acaoPersonalizada').value = '';
          document.getElementById('acaoPersonalizada').style.display = 'none';
          document.getElementById('responsavel').selectedIndex = -1;
          document.getElementById('observacao').value = '';
        } catch (error) {
          console.error('Erro ao salvar ficha:', error);
          alert('Erro ao salvar a ficha. Tente novamente.');
        }
      }
    </script>
  </body>
</html>
