<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Cadastro de Famílias</title>
  <link rel="stylesheet" href="../../css/acaocafa.css">
  <link rel="icon" href="assets/favicon.ico" type="image/x-icon" />
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <header>
    <h1>Cadastro de Famílias</h1>
  </header>

  <main>
    <div class="form-section">
      <div class="form-grid">
        <input type="text" id="liderFamilia" placeholder="Líder de Família" />
        <input type="text" id="cpfLider" placeholder="CPF do Líder" maxlength="14" oninput="mascaraCPF(this)" />
        <input type="text" id="numeroContato" placeholder="Telefone de Contato" maxlength="15" oninput="mascaraTelefone(this)" />
        <input type="date" id="dataNascimentoLider" placeholder="Data de Nascimento" />
        <input type="text" id="tituloEleitorLider" placeholder="Título de Eleitor (opcional)" maxlength="14" oninput="mascaraTitulo(this)" />
        <input type="text" id="zonaLider" placeholder="Zona do Líder (opcional)" oninput="this.value = this.value.replace(/[^0-9]/g, '')" />
        <input type="text" id="secaoLider" placeholder="Seção do Líder (opcional)" oninput="this.value = this.value.replace(/[^0-9]/g, '')" />

        <input type="text" id="nomeEsposa" placeholder="Nome do(a) Cônjuge" />
        <input type="text" id="cpfEsposa" placeholder="CPF do(a) Cônjuge" maxlength="14" oninput="mascaraCPF(this)" />
        <input type="text" id="tituloEleitorEsposa" placeholder="Título de Eleitor do(a) Cônjuge (opcional)" maxlength="14" oninput="mascaraTitulo(this)" />
        <input type="text" id="zonaEsposa" placeholder="Zona do(a) Cônjuge (opcional)" oninput="this.value = this.value.replace(/[^0-9]/g, '')" />
        <input type="text" id="secaoEsposa" placeholder="Seção do(a) Cônjuge (opcional)" oninput="this.value = this.value.replace(/[^0-9]/g, '')" />

        <input type="text" id="filhos" placeholder="Filhos" oninput="this.value = this.value.replace(/[^0-9]/g, '')" />
        <input type="text" id="localidade" placeholder="Localidade" />
      </div>
      <div class="button-row">
        <button class="btn-salvar" onclick="adicionarFicha()">Salvar</button>
        <button class="btn-fichas" onclick="window.location.href='fichacafa.html'">Registros</button>
      </div>
    </div>
  </main>

  <!-- Firebase Config -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCnPcxbJaG3kwBjU7QRmTwOYM6amuAjx1o",
      authDomain: "teste-eff5e.firebaseapp.com",
      projectId: "teste-eff5e",
      storageBucket: "teste-eff5e.appspot.com",
      messagingSenderId: "272404465161",
      appId: "1:272404465161:web:260b0242408081a17c9ad8"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <!-- Funções e Máscaras -->
  <script>
    function mascaraCPF(input) {
      let v = input.value.replace(/\D/g, "").slice(0, 11);
      v = v.replace(/(\d{3})(\d)/, "$1.$2");
      v = v.replace(/(\d{3})(\d)/, "$1.$2");
      v = v.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
      input.value = v;
    }

    function mascaraTitulo(input) {
      let v = input.value.replace(/\D/g, "").slice(0, 12);
      v = v.replace(/(\d{4})(\d{4})(\d{0,4})/, "$1 $2 $3").trim();
      input.value = v;
    }

    function mascaraTelefone(input) {
      let v = input.value.replace(/\D/g, "").slice(0, 11);
      if (v.length >= 11) {
        input.value = v.replace(/^(\d{2})(\d{5})(\d{4})$/, "($1) $2-$3");
      } else {
        input.value = v.replace(/^(\d{2})(\d{4,5})?(\d{0,4})?/, (match, p1, p2, p3) => {
          let res = `(${p1}`;
          if (p2) res += `) ${p2}`;
          if (p3) res += `-${p3}`;
          return res;
        });
      }
    }

    function validarCPF(cpf) {
      cpf = cpf.replace(/[^\d]+/g, '');
      if (cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) return false;
      let soma = 0;
      for (let i = 0; i < 9; i++) soma += parseInt(cpf.charAt(i)) * (10 - i);
      let resto = 11 - (soma % 11);
      if (resto === 10 || resto === 11) resto = 0;
      if (resto !== parseInt(cpf.charAt(9))) return false;
      soma = 0;
      for (let i = 0; i < 10; i++) soma += parseInt(cpf.charAt(i)) * (11 - i);
      resto = 11 - (soma % 11);
      if (resto === 10 || resto === 11) resto = 0;
      return resto === parseInt(cpf.charAt(10));
    }

    async function adicionarFicha() {
      const liderFamilia = document.getElementById('liderFamilia').value.trim();
      const cpfLider = document.getElementById('cpfLider').value.trim();
      const numeroContato = document.getElementById('numeroContato').value.trim();
      const dataNascimentoLider = document.getElementById('dataNascimentoLider').value.trim();
      const tituloEleitorLider = document.getElementById('tituloEleitorLider').value.trim();
      const zonaLider = document.getElementById('zonaLider').value.trim();
      const secaoLider = document.getElementById('secaoLider').value.trim();

      const nomeEsposa = document.getElementById('nomeEsposa').value.trim();
      const cpfEsposa = document.getElementById('cpfEsposa').value.trim();
      const tituloEleitorEsposa = document.getElementById('tituloEleitorEsposa').value.trim();
      const zonaEsposa = document.getElementById('zonaEsposa').value.trim();
      const secaoEsposa = document.getElementById('secaoEsposa').value.trim();

      const filhos = document.getElementById('filhos').value.trim();
      const localidade = document.getElementById('localidade').value.trim();

      if (!liderFamilia || !cpfLider || !numeroContato || !dataNascimentoLider) {
        alert('Preencha todos os campos obrigatórios.');
        return;
      }

      if (!validarCPF(cpfLider)) {
        alert('CPF do líder inválido.');
        return;
      }

      if (cpfEsposa && !validarCPF(cpfEsposa)) {
        alert('CPF do(a) cônjuge inválido.');
        return;
      }

      try {
        await db.collection('fichas_acaoexecutada').add({
          liderFamilia,
          cpfLider,
          numeroContato,
          dataNascimentoLider,
          tituloEleitorLider: tituloEleitorLider || null,
          zonaLider: zonaLider || null,
          secaoLider: secaoLider || null,
          nomeEsposa: nomeEsposa || null,
          cpfEsposa: cpfEsposa || null,
          tituloEleitorEsposa: tituloEleitorEsposa || null,
          zonaEsposa: zonaEsposa || null,
          secaoEsposa: secaoEsposa || null,
          filhos: filhos || null,
          localidade: localidade || null,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        });

        alert('Ficha salva com sucesso!');
        [
          'liderFamilia','cpfLider','numeroContato','dataNascimentoLider','tituloEleitorLider',
          'zonaLider','secaoLider',
          'nomeEsposa','cpfEsposa','tituloEleitorEsposa','zonaEsposa','secaoEsposa',
          'filhos','localidade'
        ].forEach(id => document.getElementById(id).value = '');

      } catch (error) {
        console.error('Erro ao salvar ficha:', error);
        alert('Erro ao salvar ficha. Veja o console para mais detalhes.');
      }
    }
  </script>
</body>
</html>