<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Familias Cadastradas</title>
  <link rel="stylesheet" href="../../css/fichacafa.css" />
  <link rel="icon" href="assets/favicon.ico" type="image/x-icon" />
  <link rel="stylesheet" href="css/styles.css" />
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
  <style>
    .highlight-duplicate {
      background-color: #ffe5e5 !important;
    }

    #loadingSpinner {
      display: none;
      position: fixed;
      z-index: 999;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border: 8px solid #f3f3f3;
      border-top: 8px solid #e74c3c;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }

    #contador, #contadorCompletos {
      margin-bottom: 0.5rem;
      font-weight: bold;
    }

    #duplicadosContainer {
      display: none;
      background: #f9f9f9;
      padding: 1rem;
      border: 1px solid #ccc;
      margin-top: 1rem;
      max-height: 300px;
      overflow-y: auto;
    }

    #duplicadosContainer h3 {
      margin-top: 0;
      color: #c0392b;
    }

    button {
      margin-right: 0.5rem;
    }
  </style>
</head>
<body>
  <div id="loadingSpinner"></div>
  <header><h1>Familias Cadastradas</h1></header>
  <main>
      <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCnPcxbJaG3kwBjU7QRmTwOYM6amuAjx1o",
      authDomain: "teste-eff5e.firebaseapp.com",
      projectId: "teste-eff5e",
      storageBucket: "teste-eff5e.firebasestorage.app",
      messagingSenderId: "272404465161",
      appId: "1:272404465161:web:260b0242408081a17c9ad8"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let fichasCache = [];

    function formatarDataBR(dataISO) {
      if (!dataISO) return '';
      const [ano, mes, dia] = dataISO.split("-");
      return `${dia}/${mes}/${ano.slice(2)}`;
    }

    function fichaCompleta(f) {
      return [
        f.liderFamilia, f.cpfLider, f.numeroContato, f.dataNascimentoLider,
        f.tituloEleitorLider, f.zonaLider, f.secaoLider, f.nomeEsposa,
        f.cpfEsposa, f.tituloEleitorEsposa, f.zonaEsposa, f.secaoEsposa,
        f.filhos, f.localidade
      ].every(campo => campo && campo.toString().trim() !== '');
    }

    async function carregarFichas() {
      try {
        const snapshot = await db.collection('fichas_acaoexecutada').get();
        fichasCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        ordenarEExibirFichas();
      } catch (error) {
        console.error('Erro ao carregar fichas:', error);
      }
    }

    function ordenarEExibirFichas(fichas = fichasCache) {
      const cpfs = {};
      const nomes = {};
      const duplicados = {};

      fichas.forEach(f => {
        const campos = [
          f.liderFamilia?.trim().toLowerCase(),
          f.nomeEsposa?.trim().toLowerCase(),
          f.cpfLider?.trim(),
          f.cpfEsposa?.trim()
        ];

        campos.forEach(c => {
          if (!c) return;
          duplicados[c] = duplicados[c] || [];
          duplicados[c].push(f);
        });
      });

      const duplicadosFiltrados = Object.entries(duplicados).filter(([_, v]) => v.length > 1);
      const duplicadosSet = new Set(duplicadosFiltrados.flatMap(([_, fichas]) => fichas.map(f => f.id)));

      const tbody = document.querySelector('#fichasTabela tbody');
      tbody.innerHTML = '';
      let completos = 0;

      fichas.forEach(f => {
        const tr = document.createElement('tr');
        const isDuplicado = duplicadosSet.has(f.id);
        if (isDuplicado) tr.classList.add('highlight-duplicate');
        if (fichaCompleta(f)) completos++;

        tr.innerHTML = `
          <td>${f.liderFamilia || '-'}</td>
          <td>${f.cpfLider || '-'}</td>
          <td>${f.numeroContato || '-'}</td>
          <td>${formatarDataBR(f.dataNascimentoLider || '')}</td>
          <td>${f.tituloEleitorLider || '-'}</td>
          <td>${f.zonaLider || '-'}</td>
          <td>${f.secaoLider || '-'}</td>
          <td>${f.nomeEsposa || '-'}</td>
          <td>${f.cpfEsposa || '-'}</td>
          <td>${f.tituloEleitorEsposa || '-'}</td>
          <td>${f.zonaEsposa || '-'}</td>
          <td>${f.secaoEsposa || '-'}</td>
          <td>${f.filhos || '-'}</td>
          <td>${f.localidade || '-'}</td>
          <td><button onclick="excluirFicha('${f.id}')">Excluir</button></td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById('contador').innerText = `Total de fichas: ${fichas.length}`;
      document.getElementById('contadorCompletos').innerText = `Fichas 100% completas: ${completos}`;

      exibirDuplicados(duplicadosFiltrados);
    }

    function exibirDuplicados(duplicados) {
      const lista = document.getElementById('listaDuplicados');
      lista.innerHTML = '';

      duplicados.forEach(([chave, fichas]) => {
        const li = document.createElement('li');
        const comunidades = [...new Set(fichas.map(f => f.localidade || '-'))];
        li.textContent = `${chave} - Comunidades: ${comunidades.join(', ')}`;
        lista.appendChild(li);
      });
    }

    function toggleDuplicados() {
      const container = document.getElementById('duplicadosContainer');
      container.style.display = container.style.display === 'none' ? 'block' : 'none';
    }

    async function excluirFicha(id) {
      const senha = prompt("Digite a senha para excluir:");
      if (senha !== '0000') return alert("Senha incorreta.");
      try {
        await db.collection('fichas_acaoexecutada').doc(id).delete();
        fichasCache = fichasCache.filter(f => f.id !== id);
        ordenarEExibirFichas();
      } catch (error) {
        console.error('Erro ao excluir ficha:', error);
      }
    }

    function filtrarTabela() {
      const filtro = document.getElementById('buscaInput').value.toLowerCase();
      document.querySelectorAll('#fichasTabela tbody tr').forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(filtro) ? '' : 'none';
      });
    }

    function gerarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.text('Fichas Cadastradas', 14, 15);
      doc.autoTable({
        startY: 20,
        head: [[
          'Líder de Família', 'CPF do Líder', 'Telefone de Contato', 'Data de Nascimento do Líder',
          'Título de Eleitor do Líder', 'Zona do Líder', 'Seção do Líder', 'Nome do(a) Cônjuge',
          'CPF do(a) Cônjuge', 'Título de Eleitor do(a) Cônjuge', 'Zona do(a) Cônjuge',
          'Seção do(a) Cônjuge', 'Filhos', 'Localidade'
        ]],
        body: Array.from(document.querySelectorAll('#fichasTabela tbody tr')).map(tr =>
          Array.from(tr.querySelectorAll('td')).slice(0, 14).map(td => td.innerText)
        ),
        styles: { fontSize: 7 },
      });

      doc.save('fichas_cadastradas.pdf');
    }

    async function importarBackup(event) {
      const file = event.target.files[0];
      if (!file) return;

      const spinner = document.getElementById('loadingSpinner');
      spinner.style.display = 'block';

      const reader = new FileReader();
      reader.onload = async function (e) {
        try {
          const dados = JSON.parse(e.target.result);
          if (!Array.isArray(dados)) {
            alert('Formato de backup inválido.');
            spinner.style.display = 'none';
            return;
          }

          for (const ficha of dados) {
            if (ficha.liderFamilia && ficha.cpfLider) {
              await db.collection('fichas_acaoexecutada').add({
                ...ficha,
                timestamp: firebase.firestore.Timestamp.now()
              });
            }
          }

          alert('Backup importado com sucesso!');
          carregarFichas();
        } catch (error) {
          console.error('Erro ao importar backup:', error);
          alert('Erro ao importar o backup.');
        } finally {
          spinner.style.display = 'none';
        }
      };
      reader.readAsText(file);
    }

    async function limparTodosRegistros() {
      const senha = prompt("Digite a senha para limpar todos os registros:");
      if (senha !== '0000') return alert("Senha incorreta.");
      if (!confirm('Tem certeza que deseja excluir TODOS os registros? Esta ação não pode ser desfeita.')) return;

      try {
        const snapshot = await db.collection('fichas_acaoexecutada').get();
        const batch = db.batch();

        snapshot.docs.forEach(doc => {
          batch.delete(doc.ref);
        });

        await batch.commit();
        alert('Todos os registros foram excluídos com sucesso.');
        carregarFichas();
      } catch (error) {
        console.error('Erro ao excluir todos os registros:', error);
        alert('Erro ao excluir os registros.');
      }
    }

    carregarFichas();
  </script>
</body>
</html>
    <div class="fichas-section">
      <div style="margin: 1rem 0;">
        <span id="contador">Total de fichas: 0</span><br />
        <span id="contadorCompletos">Fichas 100% completas: 0</span><br />
        <button onclick="gerarPDF()">Gerar PDF</button>
        <input type="file" id="inputBackup" accept=".json" style="display: none;" onchange="importarBackup(event)" />
        <button onclick="document.getElementById('inputBackup').click()">Importar Backup JSON</button>
        <button onclick="limparTodosRegistros()">Limpar Todos os Registros</button>
        <button onclick="toggleDuplicados()">Ver Duplicados</button>
      </div>

      <div id="duplicadosContainer">
        <h3>Lista de Duplicados</h3>
        <ul id="listaDuplicados"></ul>
      </div>

      <input type="text" id="buscaInput" placeholder="Buscar ficha..." onkeyup="filtrarTabela()" style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem;" />
      <div id="fichasContainer">
        <table id="fichasTabela" border="1" style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr>
              <th>Líder de Família</th>
              <th>CPF do Líder</th>
              <th>Telefone de Contato</th>
              <th>Data de Nascimento do Líder</th>
              <th>Título de Eleitor do Líder</th>
              <th>Zona do Líder</th>
              <th>Seção do Líder</th>
              <th>Nome do(a) Cônjuge</th>
              <th>CPF do(a) Cônjuge</th>
              <th>Título de Eleitor do(a) Cônjuge</th>
              <th>Zona do(a) Cônjuge</th>
              <th>Seção do(a) Cônjuge</th>
              <th>Filhos</th>
              <th>Localidade</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </main>
