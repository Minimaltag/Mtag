<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Ca√ßa Palavras - Defesa Civil</title>
  <link rel="stylesheet" href="../../css/caca.css" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
  <h1>Ca√ßa Palavras - Defesa Civil</h1>
  <div id="timer">Tempo restante: <span id="tempo">03:00</span></div>
  <div id="word-list"></div>
  <div id="grid"></div>
  <button class="btn" id="next-btn" style="display: none;">Pr√≥ximo N√≠vel</button>
  <button class="btn" id="desistir-btn">Desistir</button>

  <div id="game-over" style="display: none;">
    <p>üéâ Fim de jogo! üéâ</p>
    <div id="resumo-final"></div>
    <button class="btn" id="restart-btn">Reiniciar</button>
  </div>

  <script>
    const palavras = ["ALARME", "AJUDAR", "BARRA", "CHUVA", "FOGO", "GRUPO", "PLANO", "RAIO", "RISCO", "VENTO", "SOCORRO", "SECA", "SIRENE", "DANOS", "SALVAR", "PONTE", "CIVIL", "URGENCIA", "ALERTA", "DESLIZA"];
    const colunas = 9, linhas = 12;
    let nivel = parseInt(localStorage.getItem("nivel") || "1");
    const grid = document.getElementById("grid");
    const wordListEl = document.getElementById("word-list");
    const nextBtn = document.getElementById("next-btn");
    const tempoEl = document.getElementById("tempo");
    const gameOverEl = document.getElementById("game-over");
    const restartBtn = document.getElementById("restart-btn");
    const desistirBtn = document.getElementById("desistir-btn");
    const resumoFinalEl = document.getElementById("resumo-final");

    let selecionadas = [], gradeAtual = [], palavrasNivel = [], palavrasEncontradas = [];
    let timer, segundos = 180, pontosFinais = 0;
    let totalPalavrasEncontradas = 0;

    function formatarTempo(segundos) {
      const m = Math.floor(segundos / 60).toString().padStart(2, "0");
      const s = (segundos % 60).toString().padStart(2, "0");
      return `${m}:${s}`;
    }

    function iniciarCronometro() {
      clearInterval(timer);
      tempoEl.textContent = formatarTempo(segundos);
      timer = setInterval(() => {
        segundos--;
        tempoEl.textContent = formatarTempo(segundos);
        if (segundos <= 0) {
          clearInterval(timer);
          exibirGameOver();
        }
      }, 1000);
    }

    function gerarGrade(palavrasNivel) {
      const grade = Array.from({ length: linhas }, () => Array(colunas).fill(""));
      for (const palavra of palavrasNivel) {
        let colocado = false, tentativas = 0;
        while (!colocado && tentativas < 100) {
          tentativas++;
          const direcoes = [[1, 0], [0, 1], [1, 1], [-1, 1]];
          const [dx, dy] = direcoes[Math.floor(Math.random() * direcoes.length)];
          const maxX = dx === 1 ? colunas - palavra.length : dx === -1 ? palavra.length - 1 : colunas - 1;
          const maxY = dy === 1 ? linhas - palavra.length : linhas - 1;
          const x = Math.floor(Math.random() * (maxX + 1));
          const y = Math.floor(Math.random() * (maxY + 1));
          let podeColocar = true;
          for (let i = 0; i < palavra.length; i++) {
            const xi = x + dx * i;
            const yi = y + dy * i;
            if (xi < 0 || xi >= colunas || yi < 0 || yi >= linhas || (grade[yi][xi] && grade[yi][xi] !== palavra[i])) {
              podeColocar = false;
              break;
            }
          }
          if (podeColocar) {
            for (let i = 0; i < palavra.length; i++) {
              const xi = x + dx * i;
              const yi = y + dy * i;
              grade[yi][xi] = palavra[i];
            }
            colocado = true;
          }
        }
      }
      for (let y = 0; y < linhas; y++) {
        for (let x = 0; x < colunas; x++) {
          if (!grade[y][x]) grade[y][x] = String.fromCharCode(65 + Math.floor(Math.random() * 26));
        }
      }
      return grade;
    }

    function exibirGameOver() {
      clearInterval(timer);
      gameOverEl.style.display = "flex";
      resumoFinalEl.innerHTML = `
        <p>‚úÖ Palavras encontradas: ${totalPalavrasEncontradas}</p>
        <p>‚≠ê Pontua√ß√£o final: <strong>${pontosFinais} pontos</strong></p>
      `;
    }

    function renderizarGrade(grade) {
      grid.innerHTML = "";
      for (let y = 0; y < linhas; y++) {
        for (let x = 0; x < colunas; x++) {
          const div = document.createElement("div");
          div.classList.add("cell");
          div.dataset.x = x;
          div.dataset.y = y;
          div.textContent = grade[y][x];
          div.addEventListener("click", () => selecionarCelula(div));
          grid.appendChild(div);
        }
      }
    }

    function selecionarCelula(celula) {
      const x = parseInt(celula.dataset.x), y = parseInt(celula.dataset.y);
      const pos = `${x},${y}`;
      const idx = selecionadas.indexOf(pos);
      if (idx !== -1) {
        selecionadas.splice(idx, 1);
        celula.classList.remove("selected");
        return;
      }
      if (selecionadas.length === 0 || vizinhoImediato(x, y, selecionadas[selecionadas.length - 1])) {
        selecionadas.push(pos);
        celula.classList.add("selected");
      } else {
        document.querySelectorAll(".cell.selected").forEach(c => c.classList.remove("selected"));
        selecionadas = [pos];
        celula.classList.add("selected");
      }
      verificarPalavra();
    }

    function vizinhoImediato(x, y, ultimaPos) {
      const [ux, uy] = ultimaPos.split(",").map(Number);
      return Math.abs(x - ux) <= 1 && Math.abs(y - uy) <= 1;
    }

    function verificarPalavra() {
      const letras = selecionadas.map(p => {
        const [x, y] = p.split(",").map(Number);
        return gradeAtual[y][x];
      }).join("");
      if (palavrasNivel.includes(letras) && !palavrasEncontradas.includes(letras)) {
        palavrasEncontradas.push(letras);
        totalPalavrasEncontradas++;
        for (const pos of selecionadas) {
          const [x, y] = pos.split(",").map(Number);
          document.querySelector(`.cell[data-x='${x}'][data-y='${y}']`).classList.add("found");
        }
        document.querySelectorAll(".word").forEach(w => {
          if (w.textContent === letras) w.classList.add("found");
        });
        pontosFinais += letras.length * 10;
        selecionadas = [];
        if (palavrasEncontradas.length === palavrasNivel.length) {
          if (nivel < 10) {
            nivel++;
            localStorage.setItem("nivel", nivel);
            setTimeout(iniciarNivel, 1000);
          } else {
            exibirGameOver();
          }
        }
      }
    }

    function iniciarNivel() {
      gameOverEl.style.display = "none";
      palavrasNivel = [];
      while (palavrasNivel.length < 5) {
        const p = palavras[Math.floor(Math.random() * palavras.length)];
        if (!palavrasNivel.includes(p)) palavrasNivel.push(p);
      }
      palavrasEncontradas = [];
      selecionadas = [];
      gradeAtual = gerarGrade(palavrasNivel);
      renderizarGrade(gradeAtual);
      wordListEl.innerHTML = palavrasNivel.map(p => `<span class="word">${p}</span>`).join("");
      segundos = 180;
      iniciarCronometro();
    }

    restartBtn.onclick = () => {
      nivel = 1;
      localStorage.setItem("nivel", nivel);
      pontosFinais = 0;
      totalPalavrasEncontradas = 0;
      iniciarNivel();
    };

    desistirBtn.onclick = () => exibirGameOver();

    iniciarNivel();
  </script>
</body>
</html>
