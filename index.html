<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat de Emergência</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #fff3f3;
      padding: 20px;
    }
    h1 {
      color: #b30000;
    }
    textarea, button, input {
      font-size: 16px;
      margin-top: 10px;
    }
    #incidentInput {
      width: 100%;
      padding: 10px;
      border-radius: 5px;
    }
    #sendButton {
      background: #007BFF;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .incident {
      background: #ffcccc;
      padding: 10px;
      margin-top: 10px;
      border-left: 5px solid red;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>

  <h1>🚨 Chat de Emergência</h1>

  <div id="loginSection">
    <input type="email" id="email" placeholder="E-mail" /><br>
    <input type="password" id="password" placeholder="Senha" /><br>
    <button onclick="login()">🔐 Entrar</button>
    <button onclick="register()">📝 Registrar</button>
  </div>

  <div id="chatSection" class="hidden">
    <p>Bem-vindo! <button onclick="logout()">Sair</button></p>
    <textarea id="incidentInput" rows="3" placeholder="Descreva o incidente..."></textarea><br>
    <button id="sendButton">📢 Enviar Incidente</button>
    <div id="incidentList"></div>
  </div>

  <audio id="alarmSound" src="https://www.soundjay.com/button/beep-07.wav"></audio>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCnPcxbJaG3kwBjU7QRmTwOYM6amuAjx1o",
      authDomain: "teste-eff5e.firebaseapp.com",
      projectId: "teste-eff5e",
      storageBucket: "teste-eff5e.appspot.com",
      messagingSenderId: "272404465161",
      appId: "1:272404465161:web:260b0242408081a17c9ad8"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    const incidentRef = db.ref("incidents");

    const loginSection = document.getElementById("loginSection");
    const chatSection = document.getElementById("chatSection");
    const sendButton = document.getElementById("sendButton");
    const incidentInput = document.getElementById("incidentInput");
    const incidentList = document.getElementById("incidentList");
    const alarmSound = document.getElementById("alarmSound");

    // Login
    function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      auth.signInWithEmailAndPassword(email, password)
        .catch(error => alert("Erro ao entrar: " + error.message));
    }

    // Registro
    function register() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      auth.createUserWithEmailAndPassword(email, password)
        .catch(error => alert("Erro ao registrar: " + error.message));
    }

    // Logout
    function logout() {
      auth.signOut();
    }

    // Quando o usuário autenticar
    auth.onAuthStateChanged(user => {
      if (user) {
        loginSection.classList.add("hidden");
        chatSection.classList.remove("hidden");

        // Solicita permissão de notificação
        if ("Notification" in window) {
          Notification.requestPermission();
        }

        // Escuta novos incidentes
        incidentRef.off(); // evita múltiplos listeners duplicados
        incidentRef.on("child_added", (snapshot) => {
          const incident = snapshot.val();
          const div = document.createElement("div");
          div.className = "incident";
          div.textContent = `📝 ${incident.text}`;
          incidentList.prepend(div);

          alarmSound.play();

          if (Notification.permission === "granted") {
            new Notification("🚨 Novo Incidente", {
              body: incident.text,
              icon: "https://cdn-icons-png.flaticon.com/512/1828/1828911.png"
            });
          }
        });

        sendButton.onclick = () => {
          const text = incidentInput.value.trim();
          if (text) {
            incidentRef.push({
              text,
              user: user.email,
              timestamp: Date.now()
            });
            incidentInput.value = "";
          }
        };
      } else {
        chatSection.classList.add("hidden");
        loginSection.classList.remove("hidden");
      }
    });
  </script>

</body>
</html>